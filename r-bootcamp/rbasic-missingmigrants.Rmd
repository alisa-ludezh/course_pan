---
title: "Базовые функции R на примере исследования данных о пропавших мигрантах"
author: "Морозова Ю.А., ymorozova@ya.ru"
date: '12 сентября 2017 г '
output: 
  html_document: 
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Описание набора данных

Данный пример подготовлен на основе набора данных [Missing Migrants Dataset](https://www.kaggle.com/jmataya/missingmigrants).
Данные получены из Международной организации по миграции и являются частью проекта под названием Missing Migrants, цель которого - отслеживание случаев гибели мигрантов, в том числе беженцев, в процессе перемещения по миграционным маршрутам по всему миру. Исследования в рамках этого проекта начались после трагедии в октябре 2013 года, когда, по крайней мере, 368 человек погибли в результате двух кораблекрушений возле итальянского острова Лампедуза. С тех пор проект Missing Migrants превратился в важный источник, предоставляющий доступ СМИ, исследователям и широкой общественности к самой последней информации о пропавших мигрантах.

Данные имеют следующую структуру:  
1.	id - идентификатор инцидента  
2.	cause_of_death - причина смерти  
3.	region_origin - регион происхождения мигрантов    
4.	affected_nationality - национальность мигрантов  
5.	missing - количество пропавших без вести  
6.	dead - количество погибших  
7.	incident_region - регион, в котором произошел инцидент  
8.	date - дата, когда зафиксирован инцидент. В наборе данных собраны записи за период с 2014 года по июнь 2017.  
9.  source - источник информации  
10. reliability - достоверность информации  
11.	lat - географическая широта места, где произошел инцидент  
12.	lon - географическая долгота, где произошел инцидент  


```{r Загрузка библиотек и исходных данных}

library(tidyverse)
mm <- read_csv("data/MissingMigrantsProject.csv")

```

## Очистка данных

В загруженном наборе данных `r nrow(mm)` строк и `r ncol(mm)` столбцов. Первые 10 строк выглядят следующим образом:

```{r Просмотр данных}

head(mm, 10)

```

С помощью функции `summary()` получим краткую статистическую сводку о распределении значений в исходном наборе данных:


```{r Просмотр сводки}

summary(mm)

```

Для числовых столбцов набора данных в сводке можно увидеть минимальные, максимальные значения, а также среднее, медиану, 1 и 3 квартиль, количество неизвестных значений (NA). Например, среднее количество пропавших без вести - `r mean(mm$missing, na.rm=TRUE)` человек, при этом в `r sum(is.na(mm$missing))` случаях из `r nrow(mm)` количество пропавших неизвестно. Рассчитаем для каждого из столбцов количество неизвестных значений. Для этого нам нужно для каждого из столбцов проверить каждое значение, является ли оно неизвестным, с помощью функции `is.na()`. Функция `is.na()` для каждого значения вернет `true` или `false`. Далее с помощью функции `sum()` мы просуммируем значения `true`, выполнив эту операцию для каждого из столбцов набора данных `mm` с помощью функции `lapply()`:

```{r Расчет количества неизвестных значений}

lapply(mm, FUN = function(x) {sum(is.na(x))})

```

Как видно из результатов, в некоторых столбцах количество отсутствующих значений велико. Наличие в наборе данных отсутствующих значений затрудняет анализ данных, поэтому для решения проблемы необходимо что-то предпринять. Самый простой способ - это удалить или отфильтровать строки с отсутствующими значениями. Например, можно отфильтровать отсутствующие значения в столбце `missing`, следующими способами:

```{r Выборка строк по условию}

condition <- !is.na(mm$missing) ## вектор, в котором значение TRUE или FALSE соответсвует наличию или отсутствию значения в соответствующей строке столбца missing
str(condition)
mm[condition,] ## первый способ
subset(mm, condition) ## второй способ
filter(mm, condition) ## третий способ
filter(mm, complete.cases(mm)) ## фильтрация строк с пропущенными значениями в хотя бы одном из столбцов

```

Однако, в результате такой "чистки" может остаться очень малая доля исходных данных, и нам будет нечего анализировать. В нашем случае после фильтрации всех пустых значений в выборке осталось всего `r sum(complete.cases(mm))` строк. Иногда наиболее предпочтительно заменить неизвестные значения на значения по умолчанию, например, "Unknown" или наиболее типичное (среднее или медиану). Это можно сделать несколькими способами:

```{r Замена отсутствующих значений}

mm[is.na(mm$cause_of_death),"cause_of_death"] <- "Unknown" ## первый способ: делаем выборку строк с отсутствующими значениями в столбце "cause_of_death" и для них задаем новое значение "Unknown"

mm[is.na(mm$affected_nationality),"affected_nationality"] <- "Unknown"

mm[is.na(mm$incident_region),"incident_region"] <- "Unknown"

median_missing <- median(mm$missing, na.rm = TRUE)
mm[is.na(mm$missing),"missing"] <- median_missing ## заменяем отсутствующие значения в столбце "missing" на медиану

mm[is.na(mm$dead),"dead"] <- 0 ## заменяем отсутствующие значения в столбце "dead" на 0

mm$region_origin <- ifelse(is.na(mm$region_origin),"Unknown", mm$region_origin) ## второй способ: для каждой строки проверяем условие и устанавливаем новое значение, если условие выполняется

```

Поскольку для столбца `date` сложно задать значение по умолчанию, а записей с отсутствующими датами всего `r sum(is.na(mm$date))`, при этом количество погибших в этот неизвестный период зафиксировано всего `r sum(mm[is.na(mm$date),"dead"])` человек, отфильтруем эти записи из исходного набора данных.

```{r Фильтрация строк с отсутствующими датами}

mm <- filter(mm, !is.na(mm$date))
lapply(mm, FUN = function(x) {sum(is.na(x))})

```

Как видим, в отредактированных столбцах не осталось отсутствующих значений.

Обратим внимание на столбец `date`. При загрузке данных тип столбца был автоматически распознан как `r typeof(mm$date)` (строковый). Однако для работы удобнее, чтобы даты были распознаны как данные типа `Date`. Для этого можно воспользоваться функциями из пакета `lubridate`. В нашем случае даты записаны в формате "число-месяц-год", поэтому используем функцию `dmy()`:

```{r Преобразование дат}

library(lubridate)
str(mm$date)
mm$date <- dmy(mm$date)
str(mm$date)

```

## Преобразование данных

В процессе анализа данных часто возникает потребность добавить в исходный набор данных столбцы с рассчитанными показателями. Например, для группировки случаев гибели мигрантов по годам было бы удобно создать столбец `year`, в котором был бы указан год, в котором произошел инцидент. Это можно сделать с помощью `$` и функции `year()`, которая извлекает из даты год:

```{r Добавление новых столбцов}

mm$year <- year(mm$date)
str(mm$year)

```

Добавление столбцов также возможно с помощью функции `mutate()` пакета `dplyr`. Функция `mutate()` возвращает таблицу с добавленным столбцом (или несколькими столбцами), не меняя исходный набор данных, поэтому чтобы новый столбец сохранился в исходном наборе данных, нужно исходному набору данных присвоить результат, возвращенный функцией:

```{r Добавление новых столбцов с помощью mutate}

mm <- mutate(mm, dead_ratio=dead/mean(dead))
str(mm$dead_ratio)

```

## Исследование данных

Итак, мы выполнили предварительную подготовку данных, теперь можно приступить к анализу. Рассчитаем количество погибших за каждый год. Это можно сделать с помощью выборки нужных строк из набора данных и суммирования значений столбцов `dead`:

```{r Расчет погибших по годам}

sum(mm[mm$year==2014,"dead"])
sum(mm[mm$year==2015,"dead"])
sum(mm[mm$year==2016,"dead"])
sum(mm[mm$year==2017,"dead"])

```

Удобнее то же самое рассчитать с помощью функций `group by()` и `summarize()`:

```{r Расчет погибших по годам с помощью группировки}

group_by(mm, year) %>%  ## группировка строк по столбцу year
  summarize(sum(dead)) ## суммирование количества погибших для каждой группы

```

Аналогично рассчитаем количество погибших мигрантов по регионам происхождения, по национальности, по причинам смерти и по регионам, в которых произошли инциденты:

```{r Расчет погибших по различным признакам}

(by_ro <- group_by(mm, region_origin) %>%  
  summarize(dead=sum(dead))) 

(by_an <- group_by(mm, affected_nationality) %>%  
  summarize(dead=sum(dead)))

(by_cd <- group_by(mm, cause_of_death) %>%  
  summarize(dead=sum(dead)))

(by_ir <- group_by(mm, incident_region) %>%  
  summarize(dead=sum(dead))) 

```

Всего за рассматриваемый период погибло `r sum(mm$dead)` мигрантов.
Наибольшее количество погибших мигрантов происходило из региона `r by_ro[by_ro$dead==max(by_ro$dead),"region_origin"]` (`r max(by_ro$dead)` человек). 
Наибольшая доля погибших мигрантов принадлежала национальности `r by_an[by_an$dead==max(by_an$dead),"affected_nationality"]` (`r max(by_an$dead)` человек).
Наиболее частая причина смерти мигрантов - `r by_cd[by_cd$dead==max(by_cd$dead),"cause_of_death"]` (`r max(by_cd$dead)` человек).
Наибольшее количество мигрантов погибло в регионе `r by_ir[by_ir$dead==max(by_ir$dead),"incident_region"]` (`r max(by_ir$dead)` человек).

Выберем из исходного набора данных инциденты с количеством погибших выше среднего `dead_ratio > 1` и отсортируем таблицу в порядке убывания количества погибших с помощью функции `arrange()`:

```{r Выборка инцидентов с количеством погибших выше среднего}

(b_inc <- mm[mm$dead_ratio > 1, c("date","incident_region","dead","cause_of_death")]  %>%
  arrange(desc(dead))) 

```

Инцидент с наибольшим количеством погибших мигрантов произошел `r b_inc[1,"date"]` в регионе `r b_inc[1,"incident_region"]`, когда по причине `r b_inc[1,"cause_of_death"]` погибло `r b_inc[1,"dead"]` человек.

Важным инструментом анализа данных является визуализация. Поскольку в наборе данных есть информация о географической широте и долготе места, в котором произошел инцидент, у нас есть возможность отобразить эти данные о количестве погибших на карте.

```{r Визуализация данных на карте}

worldMap <- map_data("world")
ggplot(worldMap) + 
  geom_polygon(aes(long, lat, group = group), fill="white", color="grey") + 
  geom_point(data=mm, aes(lon, lat, color=dead), alpha=0.1) +
  coord_map(xlim=c(-120,120),ylim=c(-50,60))+
  labs(title="Количество погибших мигрантов по регионам", color="Количество\nпогибших\nмигрантов")
```

Интересный пример исследования данного набора данных можно найти [здесь](https://www.kaggle.com/jmataya/visualize-deadly-syrian-migrant-routes-to-europe).