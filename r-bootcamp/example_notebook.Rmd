---
title: "Пример блокнота Rmarkdown"
author: "Заходякин Г.В., postlogist@gmail.com"
date: "05.09.2017"
output: 
  html_document: 
    toc: true
    toc_float: true
---

# Введение

В отличие от скрипта, документ Rmarkdown может содержать не только код, но и текстовые пояснения, графику, формулы и результаты расчетов. В RStudio документы Rmarkdown отображаются в виде блокнотов, которые включают текст и кодовые блоки, например:

```{r Загрузка пакетов, message=FALSE, warning=FALSE}

library(tidyverse)

```


Блоки кода можно выполнять пошагово (`Ctrl-Shift-Enter`), в нужном порядке, или все сразу (см. меню на кнопке `Run` в RStudio).


```{r Загрузка и просмотр встроенного набора данных}

data(mpg)
head(mpg)

```

Результаты выводятся сразу после блока, что очень удобно.

Аналогичным образом выводятся графические и текстовые результаты.

```{r Визуализация mpg и расчет коэффициента корреляции}

# Визуализация данных
qplot(x = hwy, y = cty, data = mpg)

# Расчет коэффициента корреляции
cor.test(~ cty + hwy, data = mpg) 

```


```{r Построение и анализ модели линейной регрессии}

# Построение модели
m_cty <- lm(cty ~ hwy, data = mpg)

# Сводка по подели
summary(m_cty) 

```

Результаты расчетов можно встраивать в текст, например: 

коэффициент детерминации модели равен `r round(summary(m_cty)$r.squared, 3)`.

Визуализируем полученную модель.

```{r Визуализация модели}

# Получение коэффициентов модели
coef_m_cty <- coef(m_cty)

# Визуализация данных и тренда
qplot(x = hwy, y = cty, data = mpg) +
  geom_abline(intercept = coef_m_cty[1], 
              slope = coef_m_cty[2],
              colour = "red") +
  labs(title = "Топливная эффективность в городе и на трассе",
       y = "Пробег на галлоне топлива в городе (мили)",
       x = "Пробег на галлоне топлива на трассе (мили)") 
```

В отличие от скриптов, при обработке документов Rmarkdown предполагается, что рабочей директорией является та, в которой находится этот документ. Поэтому специально устанавливать рабочую директорию не требуется. 
Хранить исходные данные и результаты расчетов следует либо в одной папке с .Rmd документом, либо в ее подпапках. 

```{r Сохранение графика в файл}

ggsave("example_plot_2.png")

```

Хотя мы видим в блокноте результаты расчетов, .Rmd - это простой текcтовый файл, в котором содержатся только текст пояснений и код. Результаты расчетов встраиваются только при отображении документа в RStudio. Это существенно облегчает использование блокнотов с системами контроля версий, например git/Github, поскольку они предназначены для отслеживания изменений в текстовых файлах.

Если необходимо отправить результаты анализа другому человеку, то можно преобразовать документ Rmarkdown в HTML. В полученном файле будет содержаться отформатированный отчет по ходу анализа, код и результаты его выполнения. Всё необходимое будет встроено в один HTML-файл, который можно просмотреть в браузере на любом устройстве, даже если там нет R. Помимо HTML доступны и другие форматы, например Word.

Для получения HTML из документа Rmarkdown необходимо нажать кнопку `Knit` в окне RStudio.




# Пример анализа данных из Интернет

R может загружать данные не только из файлов, но и из Интернет. В качестве примера, загрузим и исследуем временной ряд из [Единого архива экономических и социально-демографических данных НИУ ВШЭ](http://sophist.hse.ru).

Для работу потребуются пакеты `forecast` и `sophisthse`, которые входят в подготовленный для курса дистрибутив. Если вы устанавливали R сами и не добавляли эти пакеты, то раскомментируйте код в следующем блоке и выполните его:

```{r Установка пакетов}
#install.packages("forecast")
#install.packages("sophisthse")
```


Загрузим пакеты (обычно это делается в самом начале блокнота)

```{r Загрузка дополнительных пакетов}
library(forecast)
library(sophisthse)
```


Загрузим данные об обороте розничной торговли в России.

```{r Загрузка данных ряда RTRD_M}
retail <- sophisthse('RTRD_M')
head(retail)
sophisthse_metadata(retail)
```

Отберем данные только по ряду: `Оборот розничной торговли в текущих ценах (RTRD_M)` и посмотрим, как выглядит ряд на графике.

```{r Визуализация временного ряда}

rtrd_m <- retail[, 'RTRD_M']
autoplot(rtrd_m)

```


Исторических данных очень много, оставим данные только с 2010 года.


```{r Отбор данных}

rtrd_subset <- window(rtrd_m, start = c(2010, 1)) #год и месяц начала

```

Изучим структуру временного ряда с помощью декомпозиции.

```{r Декомпозиция временного ряда}

autoplot(decompose(rtrd_subset, type = 'multiplicative'))

```

Видим, что после кризиса 2014 года рост отрасли замедлился.

Построим прогноз временного ряда. Вначале необходимо построить модель на основе исторических данных.Модель будет подобрана автоматически из семейства моделей экспоненциального сглаживания. 

```{r Построение и анализ модели временного ряда}

m_rtrd_subset <- ets(rtrd_subset)
summary(m_rtrd_subset)

```

Получив модель, можно построить по ней прогноз. Выберем в качестве горизонта прогнозирования 24 месяца.

```{r Прогнозирование}

f_rtrd_subset <- forecast(m_rtrd_subset, h = 24)
autoplot(f_rtrd_subset) +
  labs(title = "Прогноз оборота розничной торговли РФ, млрд. руб",
       x = NULL,
       y = NULL,
       fill = "Доверительный\nинтервал")

```


